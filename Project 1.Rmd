---
title: |
    | Project 1
    |
    | ST 502 (601)
    |
    | Due October 7, 2024
    |
    | Authors: Rachel Hardy and Trever Yoder
output: 
  pdf_document:
    toc: true
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

library(tinytex)
library(ggplot2)
library(tidyverse)
library(knitr)
library(caret)
```

\newpage

# Introduction & Goals of the Study

In order to understand what good properties of confidence are, we will need to consider the following:

* The proportion of intervals that capture the true value (hopefully 1 - $\alpha$).
* The proportion of intervals that miss above and the proportion that miss below.
* The average length of the interval.

In this project, we will compare six different methods of creating confidence intervals for a Binomial random sample.

# Methods & Functions for Creating Confidence Intervals

## Wald Interval

The Wald Interval is as follows:

\centerline{ }
\centerline{$\hat{p} \pm z_{\alpha/2}\sqrt{\frac{\hat{p}(1-\hat{p})}{n}}$}
\centerline{ }

```{r}
# Function for the Wald interval
wald_CI <- function(y, n, alpha = 0.05){
  int<- c(y/n - qnorm(1-alpha/2)*sqrt(((y/n)*(1-(y/n)))/n),
          y/n + qnorm(1-alpha/2)*sqrt(((y/n)*(1-(y/n)))/n))
  
  # If our lower bound is less than 0, we will set it to be equal to 0
  if (int[1] < 0){
    int[1] = 0
  }
  # If our upper bound is greater than 1, we will set it to be equal to 1
  if (int[2] > 1){
    int[2] = 1
  }
  
  # Returning the interval
  return(int)
}
```

## Adjusted Wald Interval

```{r}
# Function for the Adjusted Wald interval
adjwald_CI <- function (y, n, alpha=0.05){
  int <- c((y+2)/(n+4) - qnorm(1-alpha/2)*sqrt(((y+2)/(n+4))*(1-((y+2)/(n+4)))/(n+4)),
           (y+2)/(n+4) + qnorm(1-alpha/2)*sqrt(((y+2)/(n+4))*(1-((y+2)/(n+4)))/(n+4)))
  
  # If our lower bound is less than 0, we will set it to be equal to 0
  if (int[1] < 0){
    int[1] = 0
  }
  # If our upper bound is greater than 1, we will set it to be equal to 1
  if (int[2] > 1){
    int[2] = 1
  }
  
  # Returning the interval
  return(int)
}
```

## Clopper-Pearson (Exact) Interval

```{r}
# Function for the Clopper-Pearson (exact) interval
clopper_CI <- function(y, n, alpha = 0.05){

  # If y = 0, our interval will be (0,0)
  if(y == 0){
    return(c(0,0))
  }
  # If y = n, our interval will be (1,1)
  else if(y == n){
    return(c(1,1))
  }
  # If we do not have either of the two cases above, we will calculate the CI
  else{
    c((1 + (n-y+1)/(y*qf(alpha/2, 2*y, 2*(n-y+1))))**-1,
      (1 + (n-y)/((y+1)*qf(1-alpha/2, 2*(y+1), 2*(n-y))))**-1)
  }
}
```

## Score Interval

```{r}
############# REVIEW THIS #############

# Function for the score interval
score_CI <- function(y, n, alpha = 0.05){
  # Finding p_hat, i.e. the sample proportion
  p_hat <- y/n
  
  # Critical value and center
  z <- qnorm(1 - alpha/2)
  center <- (p_hat + (z**2/(2*n)))
  
  # Calculate the margin of error
  err <- z*sqrt((p_hat*(1 - p_hat) + (z**2/(4*n)))/n)
  
  # Calculate the lower and upper bounds
  upper <- (center + err)/(1 + (z**2/n))
  lower <- (center - err)/(1 + (z**2/n))
  
  # Return the interval
  return(c(lower, upper))
  
}
```

## Raw Percentile Interval (Using a Parametric Bootstrap)

```{r}
# Function for the raw percentile interval (using parametric bootstrap)
rawboot_CI <- function(y, n, alpha = 0.05, B = 100){
  # Finding p_hat, i.e. the sample proportion
  p_hat <- y/n
  
  # If y = 0, our interval will be (0,0)
  if(y == 0){
    return(c(0,0))
  }
  # If y = n, our interval will be (1,1)
  else if(y == n){
    return(c(1,1))
  }
  # If we do not have either of the two cases above, we will calculate the CI
  # Here, we will use a parametric bootstrap!
  else{
    boot_estimates <- replicate(B, {
      data <- rbinom(1, size = n, prob = p_hat)
      p_hat_boot <- data/n
      
      return(p_hat_boot)
    })
    
    # Calculate the raw percentile interval
    lower <- quantile(boot_estimates, alpha/2)
    upper <- quantile(boot_estimates, 1 - alpha/2)
  
    # Return the interval
    return(c(lower, upper))
  }
}
```

## Bootstrap t Interval (Using a Parametric Bootstrap)

```{r}

```

# Monte Carlo Simulation

Below is a nested loop that iterates over all 45 combinations of n and p. In this nested loop, we will conduct a Monte Carlo simulation for each of the six confidence interval methods using the functions we created earlier. We will then find the following properties of interest:

* Average width of the confidence intervals.
* The proportion of intervals that capture the true $p$ (hopefully 1 - $\alpha$).
* The proportion of intervals that missed high, and the proportion that missed low.

```{r}
# Setting the seed
set.seed(123)

# Setting values for B, N, n, and p
B <- 100
N <- 1000
alpha <- 0.05
n_values <- c(15, 30, 100)
p_values <- seq(from = 0.01, to = 0.99, length.out = 15)

### Make empty vectors for each CI method to store values ###

wald_width_vec <- numeric()
wald_prop_true <- numeric()
wald_miss_above <- numeric()
wald_miss_below <- numeric()

adjwald_width_vec <- numeric()
adjwald_prop_true <- numeric()
adjwald_miss_above <- numeric()
adjwald_miss_below <- numeric()

clopper_width_vec <- numeric()
clopper_prop_true <- numeric()
clopper_miss_above <- numeric()
clopper_miss_below <- numeric()

score_width_vec <- numeric()
score_prop_true <- numeric()
score_miss_above <- numeric()
score_miss_below <- numeric()

rawboot_width_vec <- numeric()
rawboot_prop_true <- numeric()
rawboot_miss_above <- numeric()
rawboot_miss_below <- numeric()

tboot_width_vec <- numeric()
tboot_prop_true <- numeric()
tboot_miss_above <- numeric()
tboot_miss_below <- numeric()

### Make empty matrices for each CI method to store CI values ###

wald_allCIs    <- matrix(ncol = 4,nrow = 0, dimnames = list(NULL, c("n", "p", 
                                                               "lower", "upper")))
adjwald_allCIs <- matrix(ncol = 4,nrow = 0, dimnames = list(NULL, c("n", "p", 
                                                                    "lower", "upper")))
clopper_allCIs <- matrix(ncol = 4,nrow = 0, dimnames = list(NULL, c("n", "p", 
                                                                    "lower", "upper")))
score_allCIs   <- matrix(ncol = 4,nrow = 0, dimnames = list(NULL, c("n", "p", 
                                                                  "lower", "upper")))
rawboot_allCIs <- matrix(ncol = 4,nrow = 0, dimnames = list(NULL, c("n", "p", 
                                                                    "lower", "upper")))
tboot_allCIs   <- matrix(ncol = 4,nrow = 0, dimnames = list(NULL, c("n", "p", 
                                                                  "lower", "upper")))

### Make empty matrices for each CI method to store results ###

wald_df    <- matrix(ncol = 6,nrow = 0, dimnames = list(NULL, c("n", "p", "avg_width",
                                                     "prop_captured", "prop_below",
                                                     "prop_above")))
adjwald_df <- matrix(ncol = 6,nrow = 0, dimnames = list(NULL, c("n", "p", "avg_width",
                                                       "prop_captured", "prop_below",
                                                       "prop_above")))
clopper_df <- matrix(ncol = 6,nrow = 0, dimnames = list(NULL, c("n", "p", "avg_width",
                                                       "prop_captured", "prop_below",
                                                       "prop_above")))
score_df   <- matrix(ncol = 6,nrow = 0, dimnames = list(NULL, c("n", "p", "avg_width",
                                                     "prop_captured", "prop_below",
                                                     "prop_above")))
rawboot_df <- matrix(ncol = 6,nrow = 0, dimnames = list(NULL, c("n", "p", "avg_width",
                                                       "prop_captured", "prop_below",
                                                       "prop_above")))
tboot_df   <- matrix(ncol = 6,nrow = 0, dimnames = list(NULL, c("n", "p", "avg_width",
                                                      "prop_captured", "prop_below",
                                                      "prop_above")))

#################################################################################

### Monte Carlo simulation in a nested loop! ###
for (n in n_values){
  for (p in p_values){
      # Randomly generating from a binomial with n and p
      data <- rbinom(N, size = n, prob = p)
      
      # For each of the 1000 random samples we will calculate a confidence interval
      # as well as the width of the interval, whether or not the true p was
      # captured, and if the interval missed high or low. We will do this for 
      # each of the six different CI methods!
      for (i in 1:N){
        y <- data[i]
        
        ############### Wald Interval ###############
        wald_CI_calc <- wald_CI(y = y, n = n, alpha = alpha)
        wald_lower   <- wald_CI_calc[1]
        wald_upper   <- wald_CI_calc[2]
        
        ############### Adjusted Wald Interval ###############
        adjwald_CI_calc <- adjwald_CI(y = y, n = n, alpha = alpha)
        adjwald_lower   <- adjwald_CI_calc[1]
        adjwald_upper   <- adjwald_CI_calc[2]
        
        ############### Clopper-Pearson Interval ###############
        clopper_CI_calc <- clopper_CI(y = y, n = n, alpha = alpha)
        clopper_lower   <- clopper_CI_calc[1]
        clopper_upper   <- clopper_CI_calc[2]
        
        ############### Score Interval ###############
        score_CI_calc <- score_CI(y = y, n = n, alpha = alpha)
        score_lower   <- score_CI_calc[1]
        score_upper   <- score_CI_calc[2]
        
        ############### Raw Percentile Interval (Bootstrap) ###############
        rawboot_CI_calc <- rawboot_CI(y = y, n = n, alpha = alpha, B = B)
        rawboot_lower   <- rawboot_CI_calc[1]
        rawboot_upper   <- rawboot_CI_calc[2]
        
        #####################################################################
        
        ### Calculating properties of interest below ###
        
        # Calculating the width of each of the 1000 intervals (for each CI)
        wald_width    <- (wald_upper - wald_lower)
        adjwald_width <- (adjwald_upper - adjwald_lower)
        clopper_width <- (clopper_upper - clopper_lower)
        score_width   <- (score_upper - score_lower)
        rawboot_width <- (rawboot_upper - rawboot_lower)
        
        # Appending each width value to a vector (for each CI)
        wald_width_vec[i]    <- wald_width
        adjwald_width_vec[i] <- adjwald_width
        clopper_width_vec[i] <- clopper_width
        score_width_vec[i]   <- score_width
        rawboot_width_vec[i] <- rawboot_width
        
        # Finding out if the interval captures the true p value (for each CI)
        wald_cap_truth    <- ((wald_lower < p) & (wald_upper > p))
        adjwald_cap_truth <- ((adjwald_lower < p) & (adjwald_upper > p))
        clopper_cap_truth <- ((clopper_lower < p) & (clopper_upper > p))
        score_cap_truth   <- ((score_lower < p) & (score_upper > p))
        rawboot_cap_truth <- ((rawboot_lower < p) & (rawboot_upper > p))
        
        # Appending each true/false value to a vector (for each CI)
        wald_prop_true[i]    <- wald_cap_truth
        adjwald_prop_true[i] <- adjwald_cap_truth
        clopper_prop_true[i] <- clopper_cap_truth
        score_prop_true[i]   <- score_cap_truth
        rawboot_prop_true[i] <- rawboot_cap_truth
        
        ## Intervals that miss below
        ## i.e. having an upper bound lower than p
        
          # Finding out if the interval misses below (for each CI)
          wald_below    <- (wald_upper < p)
          adjwald_below <- (adjwald_upper < p)
          clopper_below <- (clopper_upper < p)
          score_below   <- (score_upper < p)
          rawboot_below <- (rawboot_upper < p)
          
          # Appending each true/false value to a vector (for each CI)
          wald_miss_below[i]    <- wald_below
          adjwald_miss_below[i] <- adjwald_below
          clopper_miss_below[i] <- clopper_below
          score_miss_below[i]   <- score_below
          rawboot_miss_below[i] <- rawboot_below
        
        ## Intervals that miss above
        ## i.e. having a lower bound higher than p
        
          # Finding out if the interval misses above (for each CI)
          wald_above    <- (wald_lower > p)
          adjwald_above <- (adjwald_lower > p)
          clopper_above <- (clopper_lower > p)
          score_above   <- (score_lower > p)
          rawboot_above <- (rawboot_lower > p)
          
          # Appending each true/false value to a vector (for each CI)
          wald_miss_above[i]    <- wald_above
          adjwald_miss_above[i] <- adjwald_above
          clopper_miss_above[i] <- clopper_above
          score_miss_above[i]   <- score_above
          rawboot_miss_above[i] <- rawboot_above
        
        # Storing the CI for every random sample of every combination
        # of n and p, total of N*n*p rows (for each CI)
        wald_allCIs    <- rbind(wald_allCIs, c(n, p, wald_lower, wald_upper))
        adjwald_allCIs <- rbind(adjwald_allCIs, c(n, p, adjwald_lower, adjwald_upper))
        clopper_allCIs <- rbind(clopper_allCIs, c(n, p, clopper_lower, clopper_upper))
        score_allCIs   <- rbind(score_allCIs, c(n, p, score_lower, score_upper))
        rawboot_allCIs <- rbind(rawboot_allCIs, c(n, p, rawboot_lower, rawboot_upper))
      }
      
      ### Averaging the quantities above to get our results ###
      
      # Taking the average of the width vector (for each CI)
      wald_avg_width    <- mean(wald_width_vec)
      adjwald_avg_width <- mean(adjwald_width_vec)
      clopper_avg_width <- mean(clopper_width_vec)
      score_avg_width   <- mean(score_width_vec)
      rawboot_avg_width <- mean(rawboot_width_vec)
      
      # Proportion of intervals that capture the truth (for each CI)
      wald_prop_captured    <- mean(wald_prop_true)
      adjwald_prop_captured <- mean(adjwald_prop_true)
      clopper_prop_captured <- mean(clopper_prop_true)
      score_prop_captured   <- mean(score_prop_true)
      rawboot_prop_captured <- mean(rawboot_prop_true)
      
      # Proportion of intervals that miss below (for each CI)
      wald_prop_below    <- mean(wald_miss_below)
      adjwald_prop_below <- mean(adjwald_miss_below)
      clopper_prop_below <- mean(clopper_miss_below)
      score_prop_below   <- mean(score_miss_below)
      rawboot_prop_below <- mean(rawboot_miss_below)
      
      # Proportion of intervals that miss above (for each CI)
      wald_prop_above    <- mean(wald_miss_above)
      adjwald_prop_above <- mean(adjwald_miss_above)
      clopper_prop_above <- mean(clopper_miss_above)
      score_prop_above   <- mean(score_miss_above)
      rawboot_prop_above <- mean(rawboot_miss_above)
      
      # Putting the results found above into our matrices (for each CI)
      wald_df    <- rbind(wald_df, c(n, p, wald_avg_width, wald_prop_captured, 
                                     wald_prop_below, wald_prop_above))
      adjwald_df <- rbind(adjwald_df, c(n, p, adjwald_avg_width, adjwald_prop_captured, 
                                        adjwald_prop_below, adjwald_prop_above))
      clopper_df <- rbind(clopper_df, c(n, p, clopper_avg_width, clopper_prop_captured, 
                                        clopper_prop_below, clopper_prop_above))
      score_df   <- rbind(score_df, c(n, p, score_avg_width, score_prop_captured, 
                                      score_prop_below, score_prop_above))
      rawboot_df <- rbind(rawboot_df, c(n, p, rawboot_avg_width, rawboot_prop_captured, 
                                        rawboot_prop_below, rawboot_prop_above))
  }
}

### Final results as data frames ###

wald_df    <- data.frame(wald_df)
adjwald_df <- data.frame(adjwald_df)
clopper_df <- data.frame(clopper_df)
score_df   <- data.frame(score_df)
rawboot_df <- data.frame(rawboot_df)

### Display first and last 5 observations of each data frame ###
head(wald_df, n = 5)
tail(wald_df, n = 5)
head(adjwald_df, n = 5)
tail(adjwald_df, n = 5)
head(clopper_df, n = 5)
tail(clopper_df, n = 5)
head(score_df, n = 5)
tail(score_df, n = 5)
head(rawboot_df, n = 5)
tail(rawboot_df, n = 5)
```

\newpage

# Comparison of the Different Methods

## Results & Plots for the Wald Interval

Below is a plot of the coverage probabilities from the Wald interval simulation.

```{r}
ggplot(wald_df, aes(x = p, y = prop_captured)) +
  geom_line() +
  geom_hline(yintercept = 0.95, color = "red") +
  annotate("text", x = 0.06, y = 0.98, label = "0.95", color = "red") +
  facet_wrap(~n, labeller = labeller(n = function(x) paste("n =", x))) +
  labs(title = "Wald Interval: Proportion of Intervals Capturing True p",
       x = "p", y = "Proportion Captured") +
  theme(legend.position="none")
```

Below is a plot of the average interval width from the Wald interval simulation.

```{r}
ggplot(wald_df, aes(x = p, y = avg_width)) +
  geom_line() +
  facet_wrap(~n, labeller = labeller(n = function(x) paste("n =", x))) +
  labs(title = "Wald Interval: Average Confidence Interval Width",
       x = "p", y = "Average Width")
```

## Results & Plots for the Adjusted Wald Interval

Below is a plot of the coverage probabilities from the Adjusted Wald interval simulation.

```{r}
ggplot(adjwald_df, aes(x = p, y = prop_captured)) +
  geom_line() +
  geom_hline(yintercept = 0.95, color = "red") +
  annotate("text", x = 0.05, y = 0.948, label = "0.95", color = "red") +
  facet_wrap(~n, labeller = labeller(n = function(x) paste("n =", x))) +
  labs(title = "Adjusted Wald Interval: Proportion of Intervals Capturing True p",
       x = "p", y = "Proportion Captured") +
  theme(legend.position="none")
```

Below is a plot of the average interval width from the Adjusted Wald interval simulation.

```{r}
ggplot(adjwald_df, aes(x = p, y = avg_width)) +
  geom_line() +
  facet_wrap(~n, labeller = labeller(n = function(x) paste("n =", x))) +
  labs(title = "Adjusted Wald Interval: Average Confidence Interval Width",
       x = "p", y = "Average Width")
```

## Results & Plots for the Clopper-Pearson Interval

Below is a plot of the coverage probabilities from the Clopper-Pearson interval simulation.

```{r}
ggplot(clopper_df, aes(x = p, y = prop_captured)) +
  geom_line() +
  geom_hline(yintercept = 0.95, color = "red") +
  annotate("text", x = 0.05, y = 0.98, label = "0.95", color = "red") +
  facet_wrap(~n, labeller = labeller(n = function(x) paste("n =", x))) +
  labs(title = "Clopper-Pearson Interval: Proportion of Intervals Capturing True p",
       x = "p", y = "Proportion Captured") +
  theme(legend.position="none")
```

Below is a plot of the average interval width from the Clopper-Pearson interval simulation.

```{r}
ggplot(clopper_df, aes(x = p, y = avg_width)) +
  geom_line() +
  facet_wrap(~n, labeller = labeller(n = function(x) paste("n =", x))) +
  labs(title = "Clopper-Pearson Interval: Average Confidence Interval Width",
       x = "p", y = "Average Width")
```

## Results & Plots for the Score Interval

Below is a plot of the coverage probabilities from the Score interval simulation.

```{r}
ggplot(score_df, aes(x = p, y = prop_captured)) +
  geom_line() +
  geom_hline(yintercept = 0.95, color = "red") +
  annotate("text", x = 0.05, y = 0.945, label = "0.95", color = "red") +
  facet_wrap(~n, labeller = labeller(n = function(x) paste("n =", x))) +
  labs(title = "Score Interval: Proportion of Intervals Capturing True p",
       x = "p", y = "Proportion Captured") +
  theme(legend.position="none")
```

Below is a plot of the average interval width from the Score interval simulation.

```{r}
ggplot(score_df, aes(x = p, y = avg_width)) +
  geom_line() +
  facet_wrap(~n, labeller = labeller(n = function(x) paste("n =", x))) +
  labs(title = "Score Interval: Average Confidence Interval Width",
       x = "p", y = "Average Width")
```

## Results & Plots for the Raw Percentile Interval (Using a Parametric Bootstrap)

Below is a plot of the coverage probabilities from the raw percentile (bootstrap) interval simulation.

```{r}
ggplot(rawboot_df, aes(x = p, y = prop_captured)) +
  geom_line() +
  geom_hline(yintercept = 0.95, color = "red") +
  annotate("text", x = 0.05, y = 0.98, label = "0.95", color = "red") +
  facet_wrap(~n, labeller = labeller(n = function(x) paste("n =", x))) +
  labs(title = "Raw Percentile Interval: Proportion of Intervals Capturing True p",
       x = "p", y = "Proportion Captured") +
  theme(legend.position="none")
```

Below is a plot of the average interval width from the raw percentile (bootstrap) interval simulation.

```{r}
ggplot(rawboot_df, aes(x = p, y = avg_width)) +
  geom_line() +
  facet_wrap(~n, labeller = labeller(n = function(x) paste("n =", x))) +
  labs(title = "Raw Percentile Interval: Average Confidence Interval Width",
       x = "p", y = "Average Width")
```

## Results & Plots for the Bootstrap t Interval (Using a Parametric Bootstrap)

# Conclusions







